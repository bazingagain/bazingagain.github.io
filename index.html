<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="bazingagain">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="bazingagain">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="bazingagain">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> bazingagain </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">bazingagain</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">行者常至、为者常成</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/31/mybatis-code-analysis-framework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiaolei Peng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="bazingagain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/31/mybatis-code-analysis-framework/" itemprop="url">
                  MyBatis学习第五篇 - MyBatis源码剖析之整体框架
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-31T10:10:38+08:00">
                2017-10-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="MyBatis的框架结构"><a href="#MyBatis的框架结构" class="headerlink" title="MyBatis的框架结构"></a>MyBatis的框架结构</h3><p>MyBatis的整体框架从上层调用层到底层支持层可以分为三层：接口层、数据处理层、以及基础支持层。</p>
<p><a href="http://chenjc-it.iteye.com/blog/1460990" target="_blank" rel="external">具体分层图</a>如下：</p>
<p><img src="https://bazingagain.github.io/img/mybatis/2017_10_31/mybatis-framework.png" alt="MyBatis框架结构"></p>
<h4 id="接口层"><a href="#接口层" class="headerlink" title="接口层"></a>接口层</h4><p>接口层提供具体使用的API接口给外部调用，主要基于Mapper提供的接口，在内部用StatementId识别。</p>
<h4 id="数据处理层"><a href="#数据处理层" class="headerlink" title="数据处理层"></a>数据处理层</h4><p>数据处理层包括：参数映射，SQL解析，SQL执行，结果映射。</p>
<ul>
<li>参数映射对参数映射的配置解析以及参数类型解析的过程，底层使用ParameterHandler来处理</li>
<li>Sql解析主要包含对SQL语句的配置解析和SQL语句的动态生成，使用SqlSource对Sql语句进行包装</li>
<li>Sql执行主要是使用SimpleExecutor，BatchExecutor以及ReuseExecutor来调用JDBC执行具体的逻辑</li>
<li>结果映射层主要包含对结果映射的配置解析，数据转型等工作，底层使用ResultSetHandler处理</li>
</ul>
<h4 id="基础支持层"><a href="#基础支持层" class="headerlink" title="基础支持层"></a>基础支持层</h4><p>基础支持层提供最为基础和底层服务，包括数据库的连接管理、事务管理、配置加载和缓存管理。它们为上层的逻辑处理提供最根本的支撑。</p>
<h3 id="MyBatis的主体流程"><a href="#MyBatis的主体流程" class="headerlink" title="MyBatis的主体流程"></a>MyBatis的主体流程</h3><p>MyBatis首先解析MyBatis的XML配置文件，生成相应的配置，再解析Mapper映射文件，生成相应的MaperStatemnt等映射对象，初始化数据库连接、缓存管理、事务管理等机制。生成Sqlsession对象，通过SqlSession对象执行相应的操作。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>MyBatis通过半自动化的ORM机制，提供了对JDBC的灵活的封装，上手简单，内部通过一二级缓存，事务管理，连接池机制提供了更加实用的机制，适用于灵活多变的项目，但其也存在配置比较复杂，配置兼容性低，面向对象程度不够的缺点。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://chenjc-it.iteye.com/blog/1460990" target="_blank" rel="external">1. MyBatis框架整体设计</a><br><a href="http://blog.csdn.net/luanlouis/article/details/40422941" target="_blank" rel="external">2. MyBatis的架构设计以及实例分析</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/29/mybatis-code-analysis-cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiaolei Peng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="bazingagain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/29/mybatis-code-analysis-cache/" itemprop="url">
                  MyBatis学习第四篇 - MyBatis源码剖析之缓存
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-29T22:23:20+08:00">
                2017-10-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="MyBatis缓存"><a href="#MyBatis缓存" class="headerlink" title="MyBatis缓存"></a>MyBatis缓存</h3><h4 id="为什么MyBatis要使用缓存？"><a href="#为什么MyBatis要使用缓存？" class="headerlink" title="为什么MyBatis要使用缓存？"></a>为什么MyBatis要使用缓存？</h4><p>从源码的一次查询分析可知，MyBatis查询一次数据库，都要构造SqlSession, MapperProxyFactory, MapperProxy,StatementHandler, Connection,Statement等对象。而多数情况下，数据库查询的语句一般都不变，也就是说，在一次Session中，我们执行完全相同的SQL的概论非常高，他们返回的结果相同的概论也非常高，如果每次查询都去创建这么多的对象，非常消耗系统资源。为了充分利用查询语句大部分情况下相同导致数据结果可能相同的特性，MyBatis提供了一级和二级缓存机制，减少了资源开销，同时提高了查询效率。</p>
<h4 id="MyBatis的一级缓存"><a href="#MyBatis的一级缓存" class="headerlink" title="MyBatis的一级缓存"></a>MyBatis的一级缓存</h4><p>MyBatis的一级缓存主要在两个地方有所体现：</p>
<ol>
<li>缓存Mapper类的代理类执行时的MapperMethod对象<br>在构建SqlSession并获取Mapper的时候，通过<code>MapperProxyFactory.newInstance(sqlSession)</code>来生成一个反射代理对象：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxyFactory</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache = <span class="keyword">new</span> ConcurrentHashMap&lt;Method, MapperMethod&gt;();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperProxyFactory</span><span class="params">(Class&lt;T&gt; mapperInterface)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.mapperInterface = mapperInterface;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getMapperInterface</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mapperInterface;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> Map&lt;Method, MapperMethod&gt; <span class="title">getMethodCache</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> methodCache;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">  <span class="function"><span class="keyword">protected</span> T <span class="title">newInstance</span><span class="params">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="keyword">new</span> Class[] &#123; mapperInterface &#125;, mapperProxy); <span class="comment">//生成一个Mapper接口的代理对象，InvocationHandler为MapperProxy</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> T <span class="title">newInstance</span><span class="params">(SqlSession sqlSession)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="keyword">new</span> MapperProxy&lt;T&gt;(sqlSession, mapperInterface, methodCache);</div><div class="line">    <span class="keyword">return</span> newInstance(mapperProxy);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>再看MapperProxy这个Handler类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperProxy</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6424540398559729838L</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> SqlSession sqlSession;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; mapperInterface;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MapperProxy</span><span class="params">(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperMethod&gt; methodCache)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.sqlSession = sqlSession;</div><div class="line">    <span class="keyword">this</span>.mapperInterface = mapperInterface;</div><div class="line">    <span class="keyword">this</span>.methodCache = methodCache;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> MapperMethod mapperMethod = cachedMapperMethod(method); <span class="comment">//从缓存中获取相应方法的MapperMethod对象</span></div><div class="line">    <span class="keyword">return</span> mapperMethod.execute(sqlSession, args); <span class="comment">//最终调用SqlSession的Executor执行Mapper接口的方法</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> MapperMethod <span class="title">cachedMapperMethod</span><span class="params">(Method method)</span> </span>&#123;</div><div class="line">    MapperMethod mapperMethod = methodCache.get(method); </div><div class="line">    <span class="keyword">if</span> (mapperMethod == <span class="keyword">null</span>) &#123;</div><div class="line">      mapperMethod = <span class="keyword">new</span> MapperMethod(mapperInterface, method, sqlSession.getConfiguration());</div><div class="line">      methodCache.put(method, mapperMethod);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> mapperMethod;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出，MyBatis在每次sqlSession执行Mapper的方法调用的时候，都会将调用过的Method缓存到<code>methodCache</code>这个HashMap中，下次查询同样的方法时，直接从该HashMap中取出<code>MapperMethod</code>对象而不用再次生成。</p>
<ol>
<li>对查询结果的缓存<br>从<code>mapperMethod.execute(sqlSession, args)</code>的调用可知，MyBatis在查询的时候将会调用<code>MapperMethod.java</code>中的<code>execute</code>方法，该方法会调用sqlSession的<code>select, insert, update, delete</code>等方法，而每一个SqlSession对象都包含一个Executor对象，每个Executor对象都包含<code>PerpetualCache localCache</code>对象：</li>
</ol>
<p><img src="https://bazingagain.github.io/img/mybatis/2017_10_31/mybatis-executor.png" alt="执行器部分类图"></p>
<p>看下<code>BaseExecutor.java</code>的一些与一级缓存相关的函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> PerpetualCache localCache; <span class="comment">//内部使用HashMap存储</span></div><div class="line"></div><div class="line"> <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    BoundSql boundSql = ms.getBoundSql(parameter);</div><div class="line">    CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql); <span class="comment">//创建缓存key对象</span></div><div class="line">    <span class="keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    ErrorContext.instance().resource(ms.getResource()).activity(<span class="string">"executing a query"</span>).object(ms.getId());</div><div class="line">    <span class="keyword">if</span> (closed) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ExecutorException(<span class="string">"Executor was closed."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;</div><div class="line">      clearLocalCache();</div><div class="line">    &#125;</div><div class="line">    List&lt;E&gt; list;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      queryStack++;</div><div class="line">      list = resultHandler == <span class="keyword">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</div><div class="line">        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</div><div class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">//如果缓存中没有数据，则从数据库中查询结果</span></div><div class="line">        list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      queryStack--;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (queryStack == <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) &#123;</div><div class="line">        deferredLoad.load();</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// issue #601</span></div><div class="line">      deferredLoads.clear();</div><div class="line">      <span class="keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</div><div class="line">        <span class="comment">// issue #482</span></div><div class="line">        clearLocalCache();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> list;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">queryFromDatabase</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    List&lt;E&gt; list;</div><div class="line">    localCache.putObject(key, EXECUTION_PLACEHOLDER);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      localCache.removeObject(key);</div><div class="line">    &#125;</div><div class="line">    localCache.putObject(key, list); <span class="comment">//将从数据库中查询的结构放入本地缓存</span></div><div class="line">    <span class="keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;</div><div class="line">      localOutputParameterCache.putObject(key, parameter);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> list;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>从代码中可以看出，sqlsession每次查询的时候，首先依据MappedStatement, Parameter, RowBounds, BoundSql创建一个CacheKey对象，查询的时候首先以CacheKey为键，从localCache中查询是否有该key对应的value，有则直接取出结果返回，没有则取数据库中查询，将查询到的结果放入localCache中。</p>
<p>可以看出，在MyBatis中，对应同一个SqlSession的查询，只要两次查询的<code>statementId, parameter, rowBounds, boundSql</code>一致，那么就认为这两次查询是语义一致的（即传给JDBC的sql相同，参数也相同），只要缓存中有结果，便直接返回。</p>
<p>另外一级缓存是Session级别的缓存，对于SqlSession中的缓存Map是没有设置过期时间的，对于数据变化频繁的情况，缓存中的数据长期不更新，可能存在数据不一致的情况，但是MyBatis中的update,commit等语句执行时，会清除掉cache，所有一般不会出现该问题。</p>
<h4 id="MyBatis的二级缓存"><a href="#MyBatis的二级缓存" class="headerlink" title="MyBatis的二级缓存"></a>MyBatis的二级缓存</h4><ol>
<li>如何开启MyBatis的二级缓存？<br>首先在MyBatis的配置文件中设置<code>cacheEnable</code>为<code>true</code><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">settings</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnable"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>然后在Maper的xml配置文件中设置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.bazingagain.firstdemo.mapper.RoleMapper"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">cache</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>最后，设置select语句的<code>useCache</code>(默认为true)和<code>flushCache</code>：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span> <span class="attr">useCache</span>=<span class="string">"true"</span> <span class="attr">flushCache</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">        select id, role_name as roleName, note, create_date as createDate</div><div class="line">        from t_role</div><div class="line">        where id = #&#123;id&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>配置这三部，即可完成完成二级缓存的使用，如果需在不同存储介质中使用，可以将对象序列化。<br>二级缓存默认使用LRU模式，另外的设置可以如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">cache</span></span></div><div class="line"><span class="tag">  <span class="attr">type</span>=<span class="string">"com.xx.core.plugin.mybatis.MemcachedCache"</span></span></div><div class="line"><span class="tag">  <span class="attr">eviction</span>=<span class="string">"FIFO"</span></span></div><div class="line"><span class="tag">  <span class="attr">flushInterval</span>=<span class="string">"60000"</span></span></div><div class="line"><span class="tag">  <span class="attr">size</span>=<span class="string">"512"</span></span></div><div class="line"><span class="tag">  <span class="attr">readOnly</span>=<span class="string">"true"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>即：缓存使用FIFO模式，每隔60s刷新，存数据对象或列表的512个引用，且返回的对象是只读的。</p>
<p>二级缓存可用的收回策略有:</p>
<p>LRU – 最近最少使用的:移除最长时间不被使用的对象。<br>FIFO – 先进先出:按对象进入缓存的顺序来移除它们。<br>SOFT – 软引用:移除基于垃圾回收器状态和软引用规则的对象。<br>WEAK – 弱引用:更积极地移除基于垃圾收集器状态和弱引用规则的对象。<br>默认的是 LRU。<br>type 自定义时配置的自定义缓存处理器类</p>
<p>flushInterval(刷新间隔)可以被设置为任意的正整数,而且它们代表一个合理的毫秒 形式的时间段。默认情况是不设置,也就是没有刷新间隔,缓存仅仅调用语句时刷新。</p>
<p>size(引用数目)可以被设置为任意正整数,要记住你缓存的对象数目和你运行环境的 可用内存资源数目。默认值是 1024。</p>
<p>readOnly(只读)属性可以被设置为 true 或 false。只读的缓存会给所有调用者返回缓 存对象的相同实例。因此这些对象不能被修改。这提供了很重要的性能优势。可读写的缓存 会返回缓存对象的拷贝(通过序列化) 。这会慢一些,但是安全,因此默认是 false。<br>更多MyBatis缓存配置（如自定义缓存）请参考<a href="http://www.mybatis.org/mybatis-3/zh/sqlmap-xml.html" target="_blank" rel="external">MyBatis3</a></p>
<ol>
<li>MyBatis的缓存对象是怎么建立和查找的？<br>首先MyBatis在XML解析mapper.xml文件下的<code>&lt;cache&gt;</code>节点的信息：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</div><div class="line">      String type = context.getStringAttribute(<span class="string">"type"</span>, <span class="string">"PERPETUAL"</span>);</div><div class="line">      Class&lt;? extends Cache&gt; typeClass = typeAliasRegistry.resolveAlias(type);</div><div class="line">      String eviction = context.getStringAttribute(<span class="string">"eviction"</span>, <span class="string">"LRU"</span>);<span class="comment">//默认使用LRU缓存</span></div><div class="line">      Class&lt;? extends Cache&gt; evictionClass = typeAliasRegistry.resolveAlias(eviction);</div><div class="line">      Long flushInterval = context.getLongAttribute(<span class="string">"flushInterval"</span>);</div><div class="line">      Integer size = context.getIntAttribute(<span class="string">"size"</span>);</div><div class="line">      <span class="keyword">boolean</span> readWrite = !context.getBooleanAttribute(<span class="string">"readOnly"</span>, <span class="keyword">false</span>);</div><div class="line">      <span class="keyword">boolean</span> blocking = context.getBooleanAttribute(<span class="string">"blocking"</span>, <span class="keyword">false</span>);</div><div class="line">      Properties props = context.getChildrenAsProperties();</div><div class="line">      builderAssistant.useNewCache(typeClass, evictionClass, flushInterval, size, readWrite, blocking, props); <span class="comment">//每一个namespace下，新建一个Cache，并将其添加代Configuration的caches这个Map中</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>进一步，<code>builderAssistant.useNewCache</code>调用<code>CacheBuiler</code>的<code>build()</code>方法来创建Cache对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">useNewCache</span><span class="params">(Class&lt;? extends Cache&gt; typeClass,</span></span></div><div class="line"><span class="function"><span class="params">      Class&lt;? extends Cache&gt; evictionClass,</span></span></div><div class="line"><span class="function"><span class="params">      Long flushInterval,</span></span></div><div class="line"><span class="function"><span class="params">      Integer size,</span></span></div><div class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> readWrite,</span></span></div><div class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> blocking,</span></span></div><div class="line"><span class="function"><span class="params">      Properties props)</span> </span>&#123;</div><div class="line">          <span class="comment">//以namespace为id，将cache存放到Configuration的caches变量中</span></div><div class="line">    Cache cache = <span class="keyword">new</span> CacheBuilder(currentNamespace) </div><div class="line">        .implementation(valueOrDefault(typeClass, PerpetualCache.class))</div><div class="line">        .addDecorator(valueOrDefault(evictionClass, LruCache.class))</div><div class="line">        .clearInterval(flushInterval)</div><div class="line">        .size(size)</div><div class="line">        .readWrite(readWrite)</div><div class="line">        .blocking(blocking)</div><div class="line">        .properties(props)</div><div class="line">        .build();</div><div class="line">    configuration.addCache(cache);</div><div class="line">    currentCache = cache;</div><div class="line">    <span class="keyword">return</span> cache;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这里使用了构造器模式，另外在MyBatis二级缓存中，大量使用到委托模式，我们看下<code>CacheBuilder</code>的<code>setStandardDecorators(Cache cache)</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Cache <span class="title">setStandardDecorators</span><span class="params">(Cache cache)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      MetaObject metaCache = SystemMetaObject.forObject(cache);</div><div class="line">      <span class="keyword">if</span> (size != <span class="keyword">null</span> &amp;&amp; metaCache.hasSetter(<span class="string">"size"</span>)) &#123;</div><div class="line">        metaCache.setValue(<span class="string">"size"</span>, size);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (clearInterval != <span class="keyword">null</span>) &#123;</div><div class="line">        cache = <span class="keyword">new</span> ScheduledCache(cache);</div><div class="line">        ((ScheduledCache) cache).setClearInterval(clearInterval);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (readWrite) &#123;</div><div class="line">        cache = <span class="keyword">new</span> SerializedCache(cache);</div><div class="line">      &#125;</div><div class="line">      cache = <span class="keyword">new</span> LoggingCache(cache);</div><div class="line">      cache = <span class="keyword">new</span> SynchronizedCache(cache);</div><div class="line">      <span class="keyword">if</span> (blocking) &#123;</div><div class="line">        cache = <span class="keyword">new</span> BlockingCache(cache);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> cache;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CacheException(<span class="string">"Error building standard cache decorators.  Cause: "</span> + e, e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>  看下Cache的类结构：<br><img src="https://bazingagain.github.io/img/mybatis/2017_10_31/mybatis-cache.png" alt="MyBatis的Cache类图"></p>
<p>其中，PerpetualCache存储原始的数据，其它Cache对其进行装饰，LruCache使用了LinkedHashMap的Lru模式，FifoCache使用的Deque的队列模式，BlockingCache使用了ConCurrentHashMap+ReetrantLock的机制。</p>
<p>构造好Cache容器后，然后创建Executor对象时，会调用Configuratin的newExecutor（）方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Executor <span class="title">newExecutor</span><span class="params">(Transaction transaction, ExecutorType executorType)</span> </span>&#123;</div><div class="line">    executorType = executorType == <span class="keyword">null</span> ? defaultExecutorType : executorType;</div><div class="line">    executorType = executorType == <span class="keyword">null</span> ? ExecutorType.SIMPLE : executorType;</div><div class="line">    Executor executor;</div><div class="line">    <span class="keyword">if</span> (ExecutorType.BATCH == executorType) &#123;</div><div class="line">      executor = <span class="keyword">new</span> BatchExecutor(<span class="keyword">this</span>, transaction);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ExecutorType.REUSE == executorType) &#123;</div><div class="line">      executor = <span class="keyword">new</span> ReuseExecutor(<span class="keyword">this</span>, transaction);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      executor = <span class="keyword">new</span> SimpleExecutor(<span class="keyword">this</span>, transaction);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (cacheEnabled) &#123; <span class="comment">//如果配置使用二级缓存，则对原始的Executor进行Cache包装</span></div><div class="line">      executor = <span class="keyword">new</span> CachingExecutor(executor);</div><div class="line">    &#125;</div><div class="line">    executor = (Executor) interceptorChain.pluginAll(executor);</div><div class="line">    <span class="keyword">return</span> executor;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这里CachingExecutor实现了Executor，同时也有一个Executor成员，又一次用到了装饰器模式，最后看下<code>CachingExecutor</code>的<code>query()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span></span></div><div class="line"><span class="function">      <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">   <span class="comment">//获取二级缓存实例</span></div><div class="line">    Cache cache = ms.getCache();</div><div class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</div><div class="line">      flushCacheIfRequired(ms);</div><div class="line">      <span class="keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="keyword">null</span>) &#123;</div><div class="line">        ensureNoOutParams(ms, parameterObject, boundSql);</div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">        <span class="comment">//从二级缓存实例中找缓存数据（最终转到PerpetualCache的map上去找）</span></div><div class="line">        List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</div><div class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123; <span class="comment">//如果没有，则委托给BaseExecutor查询</span></div><div class="line">          list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</div><div class="line">          tcm.putObject(cache, key, list); <span class="comment">// 将查询结果放入缓存</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> list;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>最终完成了二级Cache的创建、加载，以及查找的过程</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>MyBatis一级缓存为内置本地缓存，无需配置，二级缓存可自行配置，并提供非常多的配置选项，从而生成不同的二级缓存策略。可以看到，MyBatis在缓存中大量使用了Decorator（装饰者）模式和Builder模式，并形成了责任链。分析MyBatis的缓存源码对于掌握如何设计和使用这些模式也提供了非常好的思路。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://blog.csdn.net/luanlouis/article/details/41408341" target="_blank" rel="external">1. MyBatis二级缓存的设计原理</a><br><a href="http://www.blogjava.net/wangxinsh55/archive/2014/08/19/414267.html?opt=admin" target="_blank" rel="external">2. MyBatis缓存机制深度剖析</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/26/mybatis-code-analysis-datasource/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiaolei Peng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="bazingagain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/26/mybatis-code-analysis-datasource/" itemprop="url">
                  MyBatis学习第三篇 - MyBatis源码剖析之数据库连接
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-26T10:16:21+08:00">
                2017-10-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="MyBatis的数据库连接方式"><a href="#MyBatis的数据库连接方式" class="headerlink" title="MyBatis的数据库连接方式"></a>MyBatis的数据库连接方式</h3><p>在配置MyBatis与数据库连接的方式的时候，我们通常在<code>mybatis-config.xml</code>配置文件中通过以下方式设置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/mybatis"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>即在MyBatis框架中，提供三种数据连接方式：</p>
<ul>
<li>POOLED</li>
<li>UNPOOLED</li>
<li>JNDI</li>
</ul>
<h3 id="构造数据源连接配置环境"><a href="#构造数据源连接配置环境" class="headerlink" title="构造数据源连接配置环境"></a>构造数据源连接配置环境</h3><p>在MyBatis初始化Configuration的时候，首先将JNDI，POOLED，UNPOOLED类型别名注册到<code>Configuration</code>下的<code>TypeAliasRegistry</code>中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Configuration</span><span class="params">()</span> </span>&#123;</div><div class="line">    typeAliasRegistry.registerAlias(<span class="string">"JDBC"</span>, JdbcTransactionFactory.class);</div><div class="line">    typeAliasRegistry.registerAlias(<span class="string">"MANAGED"</span>, ManagedTransactionFactory.class);</div><div class="line"></div><div class="line">    typeAliasRegistry.registerAlias(<span class="string">"JNDI"</span>, JndiDataSourceFactory.class);</div><div class="line">    typeAliasRegistry.registerAlias(<span class="string">"POOLED"</span>, PooledDataSourceFactory.class);</div><div class="line">    typeAliasRegistry.registerAlias(<span class="string">"UNPOOLED"</span>, UnpooledDataSourceFactory.class);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看下<code>TypeAliasRegistry.java</code>的<code>registerAlias()</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span><span class="params">(String alias, Class&lt;?&gt; value)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    String key = alias.toLowerCase(Locale.ENGLISH);</div><div class="line">    TYPE_ALIASES.put(key, value);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，MyBatis会把<code>POOLED</code>等设为key，将<code>PooledDataSourceFactory.class</code>设置为value存放到<code>TYPE_ALIASES</code>这个HashMap中。</p>
<p>在初始化Configuration的过程中，会解析mybatis-config.xml配置文件，通过解析environment下的datasoucre，得到最终的DataSource。</p>
<p>首先在<code>XMLConfigBuilder.java</code>解析environment节点：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">environmentsElement</span><span class="params">(XNode context)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (environment == <span class="keyword">null</span>) &#123;</div><div class="line">        environment = context.getStringAttribute(<span class="string">"default"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">for</span> (XNode child : context.getChildren()) &#123;</div><div class="line">        String id = child.getStringAttribute(<span class="string">"id"</span>);</div><div class="line">        <span class="keyword">if</span> (isSpecifiedEnvironment(id)) &#123;</div><div class="line">          TransactionFactory txFactory = transactionManagerElement(child.evalNode(<span class="string">"transactionManager"</span>));</div><div class="line">          DataSourceFactory dsFactory = dataSourceElement(child.evalNode(<span class="string">"dataSource"</span>)); <span class="comment">//获取数据源工厂</span></div><div class="line">          DataSource dataSource = dsFactory.getDataSource(); <span class="comment">//通过数据源工厂获取数据源</span></div><div class="line">          Environment.Builder environmentBuilder = <span class="keyword">new</span> Environment.Builder(id)</div><div class="line">              .transactionFactory(txFactory)</div><div class="line">              .dataSource(dataSource);</div><div class="line">          configuration.setEnvironment(environmentBuilder.build());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着看<code>dataSourceElement(child.evalNode(&quot;dataSource&quot;))</code>方法中的调用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String type = context.getStringAttribute(<span class="string">"type"</span>);</div><div class="line">DataSourceFactory factory = (DataSourceFactory) resolveClass(type).newInstance();</div></pre></td></tr></table></figure></p>
<p>首先，获取type字符串的信息，然后调用<code>resolveClass(type).newInstance()</code>解析该类型并实例化一个DataSourceFactory:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 1.XMLConfigBuilder.java  </span></div><div class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(String alias) &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> resolveAlias(alias); <span class="comment">//调用resolveAlias（）</span></div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveAlias(String alias) &#123; <span class="comment">//方法继承自BaseBuilder</span></div><div class="line">    <span class="keyword">return</span> typeAliasRegistry.resolveAlias(alias);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 2.TypeAliasRegistry.java</span></div><div class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">Class&lt;T&gt; <span class="title">resolveAlias</span><span class="params">(String string)</span> </span>&#123;</div><div class="line">      ...</div><div class="line">      String key = string.toLowerCase(Locale.ENGLISH);</div><div class="line">      Class&lt;T&gt; value;</div><div class="line">      <span class="keyword">if</span> (TYPE_ALIASES.containsKey(key)) &#123;</div><div class="line">        value = (Class&lt;T&gt;) TYPE_ALIASES.get(key); </div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        value = (Class&lt;T&gt;) Resources.classForName(string);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> value;</div><div class="line">      ...</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可以看到根据xml中，type设置的不同，最终会实例化不同的DataSourceFactory：</p>
<p>POOLED -&gt; PooledDataSourceFactory<br>UNPOOLED -&gt; UnPooledDataSourceFactory<br>JNDI -&gt; JndiDataSourceFactory</p>
<p><img src="https://bazingagain.github.io/img/mybatis/2017_10_26/mybatis_datasource_connection.png" alt="数据源类图"></p>
<h3 id="获取数据库连接对象"><a href="#获取数据库连接对象" class="headerlink" title="获取数据库连接对象"></a>获取数据库连接对象</h3><p>MyBatis中，每新建一个SqlSession，都会创建一个Executor，而每个Executor都包含一个Transaction，每一个Transfaction都包含一个Connection和一个DataSource。<br>在执行SQL语句的时候，最终会获取Connection并调用Statement执行SQL语句。</p>
<p>首先会从<code>BaseExecutor.java</code>中调用<code>getConnection()</code>获取数据库连接：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BaseExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> Connection <span class="title">getConnection</span><span class="params">(Log statementLog)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    Connection connection = transaction.getConnection();</div><div class="line">    <span class="keyword">if</span> (statementLog.isDebugEnabled()) &#123;</div><div class="line">      <span class="keyword">return</span> ConnectionLogger.newInstance(connection, statementLog, queryStack);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> connection;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>然后调用Transfaction（这里使用JDBCTransfaction）从DataSource中获取数据库连接：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// JDBCTransfaction.java</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">openConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">      log.debug(<span class="string">"Opening JDBC Connection"</span>);</div><div class="line">    &#125;</div><div class="line">    connection = dataSource.getConnection();  <span class="comment">//获取连接</span></div><div class="line">    <span class="keyword">if</span> (level != <span class="keyword">null</span>) &#123;</div><div class="line">      connection.setTransactionIsolation(level.getLevel());</div><div class="line">    &#125;</div><div class="line">    setDesiredAutoCommit(autoCommmit);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>到这里，就要根据不同的DataSource调用各自的<code>getConnection()</code>方法了。</p>
<h4 id="1-UnPooled调用获取"><a href="#1-UnPooled调用获取" class="headerlink" title="1. UnPooled调用获取"></a>1. UnPooled调用获取</h4><p>调用UnPooledDataSource.Java，获取数据库连接的调用链依次是：<br>getConnection() -&gt; doGetConnection(String username, String password) -&gt; doGetConnection(Properties properties)</p>
<p>看下最终的<code>doGetConnection</code>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// UnPooledDataSource.java</span></div><div class="line">  <span class="function"><span class="keyword">private</span> Connection <span class="title">doGetConnection</span><span class="params">(Properties properties)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    initializeDriver();</div><div class="line">    Connection connection = DriverManager.getConnection(url, properties);</div><div class="line">    configureConnection(connection);</div><div class="line">    <span class="keyword">return</span> connection;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>可见UnPool模式下，最终是使用<code>DriverManager</code>生成<code>Connection</code>对象。<br>同时，在UnPool模式下，每次调用SqlSession的close()方法时，最终都会调用Connection对象的close()，关闭连接。</p>
<h4 id="2-Pooled调用获取"><a href="#2-Pooled调用获取" class="headerlink" title="2. Pooled调用获取"></a>2. Pooled调用获取</h4><p>采用Unpooled模式，每次打开一个SqlSession，然后关闭，都会新建一个Connection然后关闭，我们知道频繁创建数据库连接非常消耗系统资源，MyBatis提供了Pool的数据库连接池机制来解决该问题，那它到底是怎么做的呢？</p>
<p>首先我们看下Pooled模式下的获取连接的调用链：<br>getConnection（）-&gt; popConnection(String userName, String password)</p>
<p><code>getConnection()</code>源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">return</span> popConnection(dataSource.getUsername(), dataSource.getPassword()).getProxyConnection();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>注意：这里popConnection（）实际上返回的是一个PooledConnection类，PooledConnection实现了InvocationHandler接口，这里实际上用的是代理的模式，返回的连接是代理连接对象。</p>
<p>看下<code>popConnection</code>源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> PooledConnection <span class="title">popConnection</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> SQLException </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> countedWait = <span class="keyword">false</span>;</div><div class="line">    PooledConnection conn = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">long</span> t = System.currentTimeMillis();</div><div class="line">    <span class="keyword">int</span> localBadConnectionCount = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (conn == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">synchronized</span> (state) &#123;  <span class="comment">// 锁住PoolState</span></div><div class="line">        <span class="keyword">if</span> (!state.idleConnections.isEmpty()) &#123;  <span class="comment">//空闲连接List不为空</span></div><div class="line">          <span class="comment">// Pool has available connection</span></div><div class="line">          conn = state.idleConnections.remove(<span class="number">0</span>); <span class="comment">//从空闲连接中取出连接</span></div><div class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">            log.debug(<span class="string">"Checked out connection "</span> + conn.getRealHashCode() + <span class="string">" from pool."</span>);</div><div class="line">          &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//空闲连接为空</span></div><div class="line">          <span class="comment">// Pool does not have available connection</span></div><div class="line">          <span class="keyword">if</span> (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123; <span class="comment">//活跃连接的数目小于 最大活跃连接数</span></div><div class="line">            <span class="comment">// Can create new connection</span></div><div class="line">            conn = <span class="keyword">new</span> PooledConnection(dataSource.getConnection(), <span class="keyword">this</span>); <span class="comment">//创建新的连接（真实的连接同样是采用UnPooledDataSource生成的）</span></div><div class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">              log.debug(<span class="string">"Created connection "</span> + conn.getRealHashCode() + <span class="string">"."</span>);</div><div class="line">            &#125;</div><div class="line">          &#125; <span class="keyword">else</span> &#123; <span class="comment">//活跃连接已达到最大值</span></div><div class="line">            <span class="comment">// Cannot create new connection</span></div><div class="line">            PooledConnection oldestActiveConnection = state.activeConnections.get(<span class="number">0</span>);</div><div class="line">            <span class="keyword">long</span> longestCheckoutTime = oldestActiveConnection.getCheckoutTime();</div><div class="line">            <span class="keyword">if</span> (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123; <span class="comment">//获取第一个活跃连接并判断其清除时间是否大于池的最大清除时间</span></div><div class="line">              <span class="comment">// Can claim overdue connection</span></div><div class="line">              state.claimedOverdueConnectionCount++;</div><div class="line">              state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;</div><div class="line">              state.accumulatedCheckoutTime += longestCheckoutTime;</div><div class="line">              state.activeConnections.remove(oldestActiveConnection);<span class="comment">//从activeList中移除该超时的连接</span></div><div class="line">              <span class="keyword">if</span> (!oldestActiveConnection.getRealConnection().getAutoCommit()) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                  oldestActiveConnection.getRealConnection().rollback();</div><div class="line">                &#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">                  log.debug(<span class="string">"Bad connection. Could not roll back"</span>);</div><div class="line">                &#125;  </div><div class="line">              &#125;</div><div class="line">              conn = <span class="keyword">new</span> PooledConnection(oldestActiveConnection.getRealConnection(), <span class="keyword">this</span>);<span class="comment">//新建该连接（实际上底层连接没关闭，而是重新生成了一个代理对象）</span></div><div class="line">              oldestActiveConnection.invalidate();</div><div class="line">              <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                log.debug(<span class="string">"Claimed overdue connection "</span> + conn.getRealHashCode() + <span class="string">"."</span>);</div><div class="line">              &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 无空闲连接，且激活的连接已满，则必须等待</span></div><div class="line">              <span class="comment">// Must wait</span></div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (!countedWait) &#123;</div><div class="line">                  state.hadToWaitCount++;</div><div class="line">                  countedWait = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                  log.debug(<span class="string">"Waiting as long as "</span> + poolTimeToWait + <span class="string">" milliseconds for connection."</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">long</span> wt = System.currentTimeMillis();</div><div class="line">                state.wait(poolTimeToWait);</div><div class="line">                state.accumulatedWaitTime += System.currentTimeMillis() - wt;</div><div class="line">              &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">      &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> conn;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>看一下PooledConnection的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PooledConnection</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> PooledDataSource dataSource;</div><div class="line">    <span class="keyword">private</span> Connection realConnection;</div><div class="line">    <span class="keyword">private</span> Connection proxyConnection;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PooledConnection</span><span class="params">(Connection connection, PooledDataSource dataSource)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.realConnection = connection;</div><div class="line">        <span class="keyword">this</span>.dataSource = dataSource;</div><div class="line">        <span class="keyword">this</span>.proxyConnection = (Connection) Proxy.newProxyInstance(Connection.class.getClassLoader(), IFACES, <span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getRealConnection</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> realConnection;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getProxyConnection</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> proxyConnection;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        String methodName = method.getName();</div><div class="line">        <span class="keyword">if</span> (CLOSE.hashCode() == methodName.hashCode() &amp;&amp; CLOSE.equals(methodName)) &#123;</div><div class="line">        dataSource.pushConnection(<span class="keyword">this</span>); <span class="comment">//如果要执行的方法时close方法，则将连接从activeList中移除，同时创建一个新的PooledConnection对象（真实的UnPooledConnection不释放）加入idleList中，并将移除的PooledConnection失效</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;  <span class="comment">//否则直接调用执行方法</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (!Object.class.equals(method.getDeclaringClass())) &#123;</div><div class="line">            <span class="comment">// issue #579 toString() should never fail</span></div><div class="line">            <span class="comment">// throw an SQLException instead of a Runtime</span></div><div class="line">            checkConnection();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> method.invoke(realConnection, args);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="keyword">throw</span> ExceptionUtil.unwrapThrowable(t);</div><div class="line">        &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>由此我们可以看出，Pooled模式下，返回的连接是<code>（Connection）Proxy.newProxyInstance(Connection.class.getClassLoader(), IFACES, this);</code>生成的代理对象，当我们要调用方法时，invoke首先拦截调用的方法是否是<code>close</code>方法，如果是则并不关闭真实的连接，而是将连接对象从activeConnections中移到idleConnections中，这样就实现了连接的重复利用。</p>
<h4 id="3-JNDI方式获取"><a href="#3-JNDI方式获取" class="headerlink" title="3. JNDI方式获取"></a>3. JNDI方式获取</h4><p>调用<code>JndiDataSourceFactory.java</code>来创建JNDI方式生成的DataSource：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (properties.containsKey(INITIAL_CONTEXT)&amp;&amp; properties.containsKey(DATA_SOURCE)) &#123;</div><div class="line">        Context ctx = (Context) initCtx.lookup(properties.getProperty(INITIAL_CONTEXT));</div><div class="line">        dataSource = (DataSource) ctx.lookup(properties.getProperty(DATA_SOURCE));</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (properties.containsKey(DATA_SOURCE)) &#123;</div><div class="line">        dataSource = (DataSource) initCtx.lookup(properties.getProperty(DATA_SOURCE));</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>MyBatis提供了Pooled，UnPooled，JNDI三种方式建立数据库连接，最终的连接也是在原始的JDBC上进行封装，同时在Pooled模式下，建立了连接池的机制，来重复利用数据库连接，通过反射代理的方式，来监控方法的调用。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://item.jd.com/11961241.html" target="_blank" rel="external">1.《深入浅出MyBatis技术原理与实战》</a><br><a href="http://blog.csdn.net/luanlouis/article/details/37671851" target="_blank" rel="external">2. MyBatis数据源与连接池</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/22/spring-mybatis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiaolei Peng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="bazingagain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/22/spring-mybatis/" itemprop="url">
                  MyBatis学习第二篇 - MyBatis-Spring整合
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-22T10:03:47+08:00">
                2017-10-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Spring-Mybatis整合"><a href="#Spring-Mybatis整合" class="headerlink" title="Spring-Mybatis整合"></a>Spring-Mybatis整合</h3><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>SpringMVC是一个优秀的MVC框架，非常适合用于搭建大型的应用及服务，而MyBatis则是一个优秀的持久层ORM框架，能够让我们快速编写数据库操作相关的代码。</p>
<p>将二者结合，可以发挥各自的优势，提高项目的开发效率。</p>
<h3 id="结构分析"><a href="#结构分析" class="headerlink" title="结构分析"></a>结构分析</h3><p>首先SpringMVC分为Controller层，Service层，DAO层为Spring与MyBatis结合层，相当于MyBatis中的Mapper。<br>而MyBatis则通过配置Mybatis配置文件和SQL映射文件，并在applicationContext.xml中配置SqlSession来完成Spring与MyBatis的整合工作。</p>
<h3 id="整合步骤"><a href="#整合步骤" class="headerlink" title="整合步骤"></a>整合步骤</h3><h4 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h4><p>我们使用Maven兴建Spring+Mybatis项目, 具体配置链接：<a href="https://github.com/bazingagain/MyBatisSpringMVCDemo/blob/master/pom.xml" target="_blank" rel="external">pom.xml</a></p>
<p><img src="https://bazingagain.github.io/img/mybatis/2017_10_22/spring-mybatis1.png" alt="项目结构"></p>
<h4 id="1-新建POJO类"><a href="#1-新建POJO类" class="headerlink" title="1.新建POJO类"></a>1.新建POJO类</h4><p>RoleBean.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleBean</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Integer id;</div><div class="line">    <span class="keyword">private</span> String roleName;</div><div class="line">    <span class="keyword">private</span> Date createDate;</div><div class="line">    <span class="keyword">private</span> String note;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;UserBean&gt; userList;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String roleName)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.roleName = roleName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateDate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> createDate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateDate</span><span class="params">(Date createDate)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.createDate = createDate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> note;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.note = note;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserBean&gt; <span class="title">getUserList</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> userList;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserList</span><span class="params">(List&lt;UserBean&gt; userList)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.userList = userList;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="2-新建DAO类"><a href="#2-新建DAO类" class="headerlink" title="2.新建DAO类"></a>2.新建DAO类</h4><p>RoleDao.Java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Repository</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleDao</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(RoleBean role)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(RoleBean role)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Integer id)</span></span>;</div><div class="line">    <span class="function">RoleBean <span class="title">getRole</span><span class="params">(Integer id)</span></span>;</div><div class="line">    <span class="function">List&lt;RoleBean&gt; <span class="title">findRoles</span><span class="params">(String roleName, RowBounds rowBounds)</span></span>;</div><div class="line">    <span class="function">List&lt;RoleBean&gt; <span class="title">findRoleByUserId</span><span class="params">(Integer userId)</span></span>;</div><div class="line">    <span class="function">List&lt;RoleBean&gt; <span class="title">selectRoleByPOJO</span><span class="params">(TestParams params)</span></span>;</div><div class="line">    <span class="function">List&lt;RoleBean&gt; <span class="title">selectRoleByMap</span><span class="params">(Map&lt;String, Object&gt; params)</span></span>;</div><div class="line">    <span class="function">List&lt;RoleBean&gt; <span class="title">selectRolesByAnnotation</span><span class="params">(@Param(<span class="string">"roleName"</span>)</span> String roleName, @<span class="title">Param</span><span class="params">(<span class="string">"$pageParams"</span>)</span> PageParams params)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="3-配置applicationContext-xml"><a href="#3-配置applicationContext-xml" class="headerlink" title="3.配置applicationContext.xml"></a>3.配置applicationContext.xml</h4><p>这里我们使用mybatis-spring第三方包的方式来整合，这时并不需要来自己写sqlSession的业务执行代码，而只需要在applicationContext.xml中配置该bean，spring会通过反射的方式自动去新建sqlSession并执行。<br><code>applicationContext.xm</code>映射配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></div><div class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></div><div class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com"</span> <span class="attr">use-default-filters</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Repository"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Service"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--&lt;context:component-scan base-package="com.leon.mybatisspring.dao.*"/&gt;--&gt;</span></div><div class="line">    <span class="comment">&lt;!--&lt;context:component-scan base-package="com.leon.mybatisspring.service.*"/&gt;--&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">"/css/**"</span> <span class="attr">location</span>=<span class="string">"/css/"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">"/js/**"</span> <span class="attr">location</span>=<span class="string">"/js/"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">"/image/**"</span> <span class="attr">location</span>=<span class="string">"/image/"</span>/&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/mybatis"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span> <span class="attr">scope</span>=<span class="string">"prototype"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"classpath:sqlMapConfig.xml"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basePackage"</span> <span class="attr">value</span>=<span class="string">"com.leon.mybatisspring.dao"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sqlSessionFactoryBeanName"</span> <span class="attr">value</span>=<span class="string">"sqlSessionFactory"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"annotationClass"</span> <span class="attr">value</span>=<span class="string">"org.springframework.stereotype.Repository"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--使用注解事务--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>scope=&quot;prototype&quot;</code>将sqlSession配置为多例的方式，</p>
<h4 id="4-新建Mybatis配置文件和映射文件"><a href="#4-新建Mybatis配置文件和映射文件" class="headerlink" title="4.新建Mybatis配置文件和映射文件"></a>4.新建Mybatis配置文件和映射文件</h4><p>sqlMapConfig.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE configuration</span></div><div class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></div><div class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultStatementTimeout"</span> <span class="attr">value</span>=<span class="string">"3000"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useGeneratedKeys"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultExecutorType"</span> <span class="attr">value</span>=<span class="string">"REUSE"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadingEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"role"</span> <span class="attr">type</span>=<span class="string">"com.leon.mybatisspring.pojo.RoleBean"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"com.leon.mybatisspring.pojo.UserBean"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"file"</span> <span class="attr">type</span>=<span class="string">"com.leon.mybatisspring.pojo.FileBean"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.leon.mybatisspring.plugin.PagingPlugin"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default.page"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default.pageSize"</span> <span class="attr">value</span>=<span class="string">"20"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default.useFlag"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"default.checkFlag"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mapper/role.xml"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mapper/user.xml"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mapper/file.xml"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这里我们新建了一个分页插件<code>PagingPlugin</code>，后面会讲到。</p>
<p>role.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE mapper</span></div><div class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></div><div class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.leon.mybatisspring.dao.RoleDao"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"roleMap"</span> <span class="attr">type</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"roleName"</span> <span class="attr">column</span>=<span class="string">"role_name"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"createDate"</span> <span class="attr">column</span>=<span class="string">"create_date"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"note"</span> <span class="attr">column</span>=<span class="string">"note"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"userList"</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">fetchType</span>=<span class="string">"lazy"</span></span></div><div class="line"><span class="tag">                    <span class="attr">select</span>=<span class="string">"com.leon.mybatisspring.dao.UserDao.findUserByRoleId"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultMap</span>=<span class="string">"roleMap"</span>&gt;</span></div><div class="line">        SELECT id, role_name as roleName, create_date as createDate, note</div><div class="line">         FROM t_role</div><div class="line">         WHERE id = #&#123;id&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        SELECT id, role_name as roleName, create_date as createDate, note</div><div class="line">         FROM t_role</div><div class="line">         WHERE role_name LIKE concat('%', #&#123;roleName&#125;, '%')</div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoleByUserId"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span> <span class="attr">resultMap</span>=<span class="string">"roleMap"</span>&gt;</span></div><div class="line">        SELECT a.id, a.role_name, create_date, note</div><div class="line">        FROM t_role a, t_user_role b</div><div class="line">        WHERE a.id = b.role_id and b.user_id = #&#123;userId&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectRoleByMap"</span> <span class="attr">parameterType</span>=<span class="string">"map"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        SELECT id, role_name as roleName, create_date as createDate, note</div><div class="line">        FROM t_role</div><div class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null"</span>&gt;</span></div><div class="line">            WHERE role_name LIKE concat('%', #&#123;roleName&#125;, '%')</div><div class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectRolesByAnnotation"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        SELECT id, role_name as roleName, create_date as createDate, note</div><div class="line">        FROM t_role</div><div class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null"</span>&gt;</span></div><div class="line">            WHERE role_name LIKE concat('%', #&#123;roleName&#125;, '%')</div><div class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectRoleByPOJO"</span> <span class="attr">parameterType</span>=<span class="string">"com.leon.mybatisspring.pojo.TestParams"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        SELECT id, role_name as roleName, create_date as createDate, note</div><div class="line">        FROM t_role</div><div class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null"</span>&gt;</span></div><div class="line">            WHERE role_name LIKE concat('%', #&#123;roleName&#125;, '%')</div><div class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        UPDATE t_role</div><div class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null"</span>&gt;</span>role_name = #&#123;roleName&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"note != null"</span>&gt;</span>note = #&#123;note&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></div><div class="line">        WHERE id = #&#123;id&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        INSERT INTO t_role(role_name, create_date, note)</div><div class="line">        VALUES (#&#123;roleName&#125;, #&#123;createDate&#125;, #&#123;note&#125;)</div><div class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteRole"</span> <span class="attr">parameterType</span>=<span class="string">"int"</span>&gt;</span></div><div class="line">        DELETE FROM t_role</div><div class="line">        WHERE id = #&#123;id&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>要注意的是这里我们使用了<code>collection</code>的<code>1:n</code>的级联模式，<code>fetchType=&quot;lazy&quot;</code>表示只有当要取userList的时候，级联的SQL语句才会真正去执行。</p>
<h4 id="6-新建Service层"><a href="#6-新建Service层" class="headerlink" title="6.新建Service层"></a>6.新建Service层</h4><p>RoleService.Java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleService</span> </span>&#123;</div><div class="line">    <span class="function">RoleBean <span class="title">getRole</span><span class="params">(Integer id)</span></span>;</div><div class="line">    <span class="function">List&lt;RoleBean&gt; <span class="title">findRoles</span><span class="params">(String roleName, <span class="keyword">int</span> start, <span class="keyword">int</span> limit)</span></span>;</div><div class="line">    <span class="function">List&lt;RoleBean&gt; <span class="title">selectRoleByMap</span><span class="params">(Map&lt;String, Object&gt; params)</span></span>;</div><div class="line">    <span class="function">List&lt;RoleBean&gt; <span class="title">selectRoleByPOJO</span><span class="params">(TestParams params)</span></span>;</div><div class="line">    <span class="function">List&lt;RoleBean&gt; <span class="title">selectRolesByAnnotation</span><span class="params">(String roleName, PageParams params)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(RoleBean roleBean)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(RoleBean roleBean)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Integer id)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>并制定其实现类RoleServiceImpl.Java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleServiceImpl</span> <span class="keyword">implements</span> <span class="title">RoleService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RoleDao roleDao;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> RoleBean <span class="title">getRole</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleDao.getRole(id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;RoleBean&gt; <span class="title">findRoles</span><span class="params">(String roleName, <span class="keyword">int</span> start, <span class="keyword">int</span> limit)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleDao.findRoles(roleName, <span class="keyword">new</span> RowBounds(start, limit));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;RoleBean&gt; <span class="title">selectRoleByMap</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleDao.selectRoleByMap(params);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;RoleBean&gt; <span class="title">selectRoleByPOJO</span><span class="params">(TestParams params)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleDao.selectRoleByPOJO(params);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;RoleBean&gt; <span class="title">selectRolesByAnnotation</span><span class="params">(String roleName, PageParams params)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleDao.selectRolesByAnnotation(roleName, params);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(RoleBean roleBean)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleDao.insertRole(roleBean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(RoleBean roleBean)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleDao.updateRole(roleBean);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Integer id)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleDao.deleteRole(id);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里使用<code>@Service</code>注解标注服务实现类</p>
<h4 id="7-最后制定Controller类"><a href="#7-最后制定Controller类" class="headerlink" title="7.最后制定Controller类"></a>7.最后制定Controller类</h4><p>RoleController.Java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/role"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoleContoller</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span> RoleService roleService;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/getRole"</span>)</div><div class="line"><span class="comment">//    @ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getRole</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id) </span>&#123;</div><div class="line">        RoleBean role = roleService.getRole(id);</div><div class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView(<span class="string">"role/role"</span>);</div><div class="line">        List&lt;UserBean&gt; list = role.getUserList();</div><div class="line">        <span class="keyword">for</span> (UserBean user : list) &#123;</div><div class="line">            System.out.println(user.getUserName());</div><div class="line">        &#125;</div><div class="line">        mv.addObject(<span class="string">"role"</span>, role);</div><div class="line">        <span class="keyword">return</span> mv;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/findRoles"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;RoleBean&gt; <span class="title">findRoles</span><span class="params">(@RequestParam(<span class="string">"roleName"</span>)</span> String roleName, @<span class="title">RequestParam</span><span class="params">(<span class="string">"start"</span>)</span> <span class="keyword">int</span> start, @<span class="title">RequestParam</span><span class="params">(<span class="string">"limit"</span>)</span> <span class="keyword">int</span> limit) </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleService.findRoles(roleName, start, limit);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/selectRolesByMap"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;RoleBean&gt; <span class="title">selectRolesByMap</span><span class="params">(@RequestParam(<span class="string">"roleName"</span>)</span> String roleName) </span>&#123;</div><div class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">        PageParams pageParams = <span class="keyword">new</span> PageParams();</div><div class="line">        pageParams.setUseFlag(<span class="keyword">true</span>);</div><div class="line">        pageParams.setCheckFlag(<span class="keyword">false</span>);</div><div class="line">        pageParams.setPage(<span class="number">2</span>);</div><div class="line">        pageParams.setPageSize(<span class="number">5</span>);</div><div class="line">        map.put(<span class="string">"$pageParams"</span>, pageParams);</div><div class="line">        map.put(<span class="string">"roleName"</span>, <span class="string">"teacher"</span>);</div><div class="line">        List list = roleService.selectRoleByMap(map);</div><div class="line">        System.out.println(<span class="string">"total item number:"</span> + pageParams.getTotal());</div><div class="line">        System.out.println(<span class="string">"total page number:"</span> + pageParams.getTotalPage());</div><div class="line">        <span class="keyword">return</span> list;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/selectRolesByPOJO"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;RoleBean&gt; <span class="title">selectRolesByPOJO</span><span class="params">(@RequestParam(<span class="string">"roleName"</span>)</span> String roleName) </span>&#123;</div><div class="line">        TestParams pageParams = <span class="keyword">new</span> TestParams();</div><div class="line">        pageParams.setUseFlag(<span class="keyword">true</span>);</div><div class="line">        pageParams.setCheckFlag(<span class="keyword">false</span>);</div><div class="line">        pageParams.setPage(<span class="number">2</span>);</div><div class="line">        pageParams.setPageSize(<span class="number">5</span>);</div><div class="line">        pageParams.setRoleName(<span class="string">"teacher"</span>);</div><div class="line">        List list = roleService.selectRoleByPOJO(pageParams);</div><div class="line">        System.out.println(<span class="string">"total item number:"</span> + pageParams.getTotal());</div><div class="line">        System.out.println(<span class="string">"total page number:"</span> + pageParams.getTotalPage());</div><div class="line">        <span class="keyword">return</span> list;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/selectRolesByAnnotation"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;RoleBean&gt; <span class="title">selectRolesByAnnotation</span><span class="params">(@RequestParam(<span class="string">"roleName"</span>)</span> String roleName) </span>&#123;</div><div class="line">        PageParams pageParams = <span class="keyword">new</span> PageParams();</div><div class="line">        pageParams.setUseFlag(<span class="keyword">true</span>);</div><div class="line">        pageParams.setCheckFlag(<span class="keyword">false</span>);</div><div class="line">        pageParams.setPage(<span class="number">1</span>);</div><div class="line">        pageParams.setPageSize(<span class="number">5</span>);</div><div class="line">        List list = roleService.selectRolesByAnnotation(<span class="string">"teacher"</span>, pageParams);</div><div class="line">        System.out.println(<span class="string">"total item number:"</span> + pageParams.getTotal());</div><div class="line">        System.out.println(<span class="string">"total page number:"</span> + pageParams.getTotalPage());</div><div class="line">        <span class="keyword">return</span> list;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/updateRole"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateRole</span><span class="params">(RoleBean role)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleService.updateRole(role);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/insertRole"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(RoleBean role)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleService.insertRole(role);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/deleteRole"</span>)</div><div class="line">    <span class="meta">@ResponseBody</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> <span class="keyword">int</span> id) </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleService.deleteRole(id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="8-测试"><a href="#8-测试" class="headerlink" title="8.测试"></a>8.测试</h4><ol>
<li><p>查询数据并显示<br>请求<code>/role/getRole?id=2</code>，可以看到结果：<br><img src="https://bazingagain.github.io/img/mybatis/2017_10_22/spring-mybatis2.png" alt="查询数据"></p>
</li>
<li><p>数据分页查询<br>请求<code>/testPaging.jsp</code>，测试<code>Test Map</code> 可以看到结果：<br><img src="https://bazingagain.github.io/img/mybatis/2017_10_22/spring-mybatis3.png" alt="分页查询"></p>
</li>
<li><p>文件上传<br>请求<code>/uploadFile.jsp</code>，测试文件上传，可以看到上传结果：<br><img src="https://bazingagain.github.io/img/mybatis/2017_10_22/spring-mybatis4.png" alt="文件上传界面"><br><img src="https://bazingagain.github.io/img/mybatis/2017_10_22/spring-mybatis5.png" alt="文件上传结果"></p>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>SpringMVC + MyBatis的结合总体来说整合简单，配置比较简单，提供了对SQL操作的最大的灵活度，可以根据实际状态变化要执行的SQL，另外，其提供的级联方式也比较多，这对于复杂的大型项目来说非常实用，同时我们也可以采用MyBatis提供的插件机制编写分页插件，而不用每次取出所有数据再在其中截取片段，优化了查询时间。</p>
<p>同时Mybatis也存在SQL编写工作量大，SQL语句依赖数据库规范，移植性差等缺点。在项目中应当结合项目自身特点和应用场景，选择合适的ORM框架。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://item.jd.com/11961241.html" target="_blank" rel="external">1.《深入浅出MyBatis技术原理与实践》</a></p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p><a href="https://github.com/bazingagain/MyBatisSpringMVCDemo" target="_blank" rel="external">Spring-MyBatis整合源码</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/16/philosopher/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiaolei Peng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="bazingagain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/16/philosopher/" itemprop="url">
                  哲学家进餐的并发问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-16T14:59:15+08:00">
                2017-10-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="什么是哲学家进餐问题"><a href="#什么是哲学家进餐问题" class="headerlink" title="什么是哲学家进餐问题"></a>什么是哲学家进餐问题</h3><p>哲学家进餐问题由 Dijkstra 提出，是一个经典的同步问题。</p>
<p><img src="https://bazingagain.github.io/img/philosopher.png" alt="哲学家进餐问题"></p>
<p>n哲学家进餐问题描述有五个哲学家，他们的生活方式是交替地进行思考和进餐，n哲学家们共用一张圆桌，分别坐在周围的五张椅子上，在圆桌上有五个碗和五支筷子，平时哲学家进行思考，饥饿时便试图取其左、右最靠近他的筷子，只有在他拿到两支筷子时才能进餐，当哲学家进餐完毕，放下筷子又继续思考。</p>
<h3 id="哲学家进餐的死锁问题"><a href="#哲学家进餐的死锁问题" class="headerlink" title="哲学家进餐的死锁问题"></a>哲学家进餐的死锁问题</h3><p>如果每个哲学家同时拿起自己左边的筷子，同时等待右边的哲学家放下筷子，则形成了环路等待，产生死锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.leon.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created on 16/10/2017.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> Xiaolei-Peng</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chopstick</span></span>&#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Chopstick left, right;</div><div class="line">    <span class="keyword">private</span> Random random;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(Chopstick left, Chopstick right)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.left = left;</div><div class="line">        <span class="keyword">this</span>.right = right;</div><div class="line">        <span class="keyword">this</span>.random = <span class="keyword">new</span> Random();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                Thread.sleep(random.nextInt(<span class="number">1000</span>));</div><div class="line">                <span class="keyword">synchronized</span> (left) &#123;</div><div class="line">                    <span class="keyword">synchronized</span> (right) &#123;</div><div class="line">                        Thread.sleep(random.nextInt(<span class="number">1000</span>));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如上面的代码所示，通过内置的<em>synchronized</em>锁进行同步，看似没有问题，但是当所有哲学家都取得<em>left</em>筷子时，再取<em>right</em>筷子便发生了环路等待，产生死锁。同时，由于产生死锁后，各线程阻塞，而阻塞线程无法被终端，程序不能从死锁中恢复，只能杀死JVM进程。</p>
<h3 id="哲学家进餐问题的死锁解决办法"><a href="#哲学家进餐问题的死锁解决办法" class="headerlink" title="哲学家进餐问题的死锁解决办法"></a>哲学家进餐问题的死锁解决办法</h3><p>从哲学家进餐的问题中我们可以看到，产生死锁是由于请求资源的顺序不合理，形成了环路等待，导致线程阻塞。要解决该问题，有两种做法：</p>
<h4 id="1-采用固定顺序获取-比如先拿序号小的筷子，再拿序号大的筷子"><a href="#1-采用固定顺序获取-比如先拿序号小的筷子，再拿序号大的筷子" class="headerlink" title="1. 采用固定顺序获取(比如先拿序号小的筷子，再拿序号大的筷子)"></a>1. 采用固定顺序获取(比如先拿序号小的筷子，再拿序号大的筷子)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.leon.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created on 16/10/2017.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> Xiaolei-Peng</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chopstick</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> id;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = id;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Chopstick first, second;</div><div class="line">    <span class="keyword">private</span> Random random;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(Chopstick left, Chopstick right)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (left.getId() &lt; right.getId()) &#123;</div><div class="line">            <span class="keyword">this</span>.first = left;</div><div class="line">            <span class="keyword">this</span>.second = right;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.first = right;</div><div class="line">            <span class="keyword">this</span>.second = first;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.random = <span class="keyword">new</span> Random();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                Thread.sleep(random.nextInt(<span class="number">1000</span>));</div><div class="line">                <span class="keyword">synchronized</span> (first) &#123;   <span class="comment">//获取筷子1</span></div><div class="line">                    <span class="keyword">synchronized</span> (second) &#123;  <span class="comment">//获取筷子2</span></div><div class="line">                        Thread.sleep(random.nextInt(<span class="number">1000</span>));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-采用可中断锁-ReetrantLock（锁恢复）"><a href="#2-采用可中断锁-ReetrantLock（锁恢复）" class="headerlink" title="2. 采用可中断锁 ReetrantLock（锁恢复）"></a>2. 采用可中断锁 ReetrantLock（锁恢复）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.leon.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created on 16/10/2017.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> Xiaolei-Peng</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> ReentrantLock left, right;</div><div class="line">    <span class="keyword">private</span> Random random;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(ReentrantLock left, ReentrantLock right)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.left = left;</div><div class="line">        <span class="keyword">this</span>.right = right;</div><div class="line">        <span class="keyword">this</span>.random = <span class="keyword">new</span> Random();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                Thread.sleep(random.nextInt(<span class="number">1000</span>));  <span class="comment">//思考</span></div><div class="line">                left.lock();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (right.tryLock(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            Thread.sleep(random.nextInt(<span class="number">1000</span>)); <span class="comment">//进餐</span></div><div class="line">                        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                            right.unlock();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    left.unlock();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此种方法并不能避免死锁的发生，只是提供了死锁恢复的手段，同时，如果所有死锁线程同时超时，则它们可能会再次陷入死锁—即活锁效应。</p>
<h4 id="3-竞争对象转移（将对筷子的争夺转换成对状态的判断）"><a href="#3-竞争对象转移（将对筷子的争夺转换成对状态的判断）" class="headerlink" title="3. 竞争对象转移（将对筷子的争夺转换成对状态的判断）"></a>3. 竞争对象转移（将对筷子的争夺转换成对状态的判断）</h4><p>从另一个角度看，仅当哲学家左右邻座都没有进餐时，他才可以进餐，即将等待条件变为<em>!(left.eating || right.left)</em></p>
<p>这里我们采用条件变量的形式来解决哲学家进餐问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.leon.test;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created on 16/10/2017.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> Xiaolei-Peng</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Philosopher</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> eating;</div><div class="line">    <span class="keyword">private</span> Philosopher left, right;</div><div class="line">    <span class="keyword">private</span> ReentrantLock table;</div><div class="line">    <span class="keyword">private</span> Condition condition;</div><div class="line">    <span class="keyword">private</span> Random random;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Philosopher</span><span class="params">(ReentrantLock table)</span> </span>&#123;</div><div class="line">        eating = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">this</span>.table = table;</div><div class="line">        condition = table.newCondition();</div><div class="line">        <span class="keyword">this</span>.random = <span class="keyword">new</span> Random();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLeft</span><span class="params">(Philosopher left)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.left = left;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRight</span><span class="params">(Philosopher right)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.right = right;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                think();</div><div class="line">                eat();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">think</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        table.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            eating = <span class="keyword">false</span>;</div><div class="line">            left.condition.signal();</div><div class="line">            right.condition.signal();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            table.unlock();</div><div class="line">        &#125;</div><div class="line">        Thread.sleep(<span class="number">1000</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        table.lock();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (left.eating || right.eating)</div><div class="line">                condition.await();</div><div class="line">            eating = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            table.unlock();</div><div class="line">        &#125;</div><div class="line">        Thread.sleep(<span class="number">1000</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>针对哲学家进餐的死锁问题，从内置锁到可中断的ReentrantLock，再到条件变量，最终比较好地解决了哲学家进餐的死锁问题。</p>
<p>从中也可以看到，针对一个问题，从不同的角度，会得到不同的解法，而这也是我们要从中取探讨学习的。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://item.jd.com/11668493.html" target="_blank" rel="external">1.《七周七并发模型》</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/29/mybatis-first-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiaolei Peng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="bazingagain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/29/mybatis-first-md/" itemprop="url">
                  MyBatis学习第一篇 - Mybatis入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-29T20:03:23+08:00">
                2017-09-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="什么是MyBatis？"><a href="#什么是MyBatis？" class="headerlink" title="什么是MyBatis？"></a>什么是MyBatis？</h3><p>MyBatis是一个持久层框架，它对JDBC进行了一层深度的封装，提供了动态SQL，存储过程以及ORM等能力。</p>
<h3 id="为什么要用MyBatis？"><a href="#为什么要用MyBatis？" class="headerlink" title="为什么要用MyBatis？"></a>为什么要用MyBatis？</h3><p>我们知道，Hibernate也是一个优秀的持久层ORM框架，为什么不用Hibernate呢？<br>其实，在使用Hibernate的时候，会遇到如下问题：<br>1.Hibernate使用全表映射，更新时需要发送所有的字段<br>2.Hibernate无法根据不同的条件组装不同的SQL<br>3.对多表关联和复杂SQL支持差，查询后的数据需自己组装成POJO<br>4.不能有效使用存储过程（其实个人建议尽量不要使用存储过程）<br>而这些问题都能够被MyBatis很好的解决。</p>
<h3 id="MyBatis架构"><a href="#MyBatis架构" class="headerlink" title="MyBatis架构"></a>MyBatis架构</h3><p><img src="https://bazingagain.github.io/img/mybatis_framework.png" alt="MyBatis架构图"></p>
<h3 id="MyBatis的简单使用"><a href="#MyBatis的简单使用" class="headerlink" title="MyBatis的简单使用"></a>MyBatis的简单使用</h3><p>根据MyBatis的架构图，设计代码结构如下：<br><img src="https://bazingagain.github.io/img/mybatis_first.png" alt="MyBatisDemo代码设计层次"></p>
<p>1.在pom.xml中引入mybatis，mysql-connector依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></div><div class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.bazingagain<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>2.新建POJO和对象映射配置文件：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Long id;</div><div class="line">    <span class="keyword">private</span> String roleName;</div><div class="line">    <span class="keyword">private</span> String note;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.id = id;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoleName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> roleName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoleName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.roleName = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNote</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> note;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNote</span><span class="params">(String note)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.note = note;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.bazingagain.firstdemo.mapper.RoleMapper"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        select id, role_name as roleName, note</div><div class="line">        from t_role</div><div class="line">        where id = #&#123;id&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        insert</div><div class="line">        into t_role(role_name, note)</div><div class="line">        values(#&#123;roleName&#125;, #&#123;note&#125;)</div><div class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></div><div class="line">        delete</div><div class="line">        from t_role</div><div class="line">        where id = #&#123;id&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure>
<p>3.新建访问接口Mapper：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> com.bazingagain.firstdemo.object.Role;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RoleMapper</span> </span>&#123;</div><div class="line">    <span class="function">Role <span class="title">getRole</span><span class="params">(Long id)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertRole</span><span class="params">(Role role)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteRole</span><span class="params">(Long id)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>4.新建MyBatis配置文件：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE configuration</span></div><div class="line"><span class="meta">  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></div><div class="line"><span class="meta">  "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">"com.bazingagain.firstdemo.object.Role"</span> <span class="attr">alias</span>=<span class="string">"role"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">"com.bazingagain.firstdemo.object.User"</span> <span class="attr">alias</span>=<span class="string">"user"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">typeHandler</span> <span class="attr">handler</span>=<span class="string">"org.apache.ibatis.type.EnumOrdinalTypeHandler"</span> <span class="attr">javaType</span>=<span class="string">"com.bazingagain.firstdemo.enums.Gender"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"autoCommit"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost:3306/mybatis"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"RoleMapper.xml"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"userMapper.xml"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>5.其它辅助类：<br>SqlSessionFactoryUtil：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.bazingagain.firstdemo.utils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</div><div class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</div><div class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</div><div class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</div><div class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created on 13/09/2017.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> Xiaolei-Peng</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SqlSessionFactoryUtil</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = Logger.getLogger(SqlSessionFactoryUtil.class);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class CLASS_LOCK = SqlSessionFactoryUtil.class;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SqlSessionFactoryUtil</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">initSqlSessionFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">        String resources = <span class="string">"mybatis-config.xml"</span>;</div><div class="line">        InputStream inputStream = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            inputStream = Resources.getResourceAsStream(resources);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            logger.info(e.getCause());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (CLASS_LOCK) &#123;</div><div class="line">            <span class="keyword">if</span> (sqlSessionFactory == <span class="keyword">null</span>) &#123;</div><div class="line">                sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sqlSessionFactory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title">openSqlSession</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (sqlSessionFactory == <span class="keyword">null</span>) &#123;</div><div class="line">            initSqlSessionFactory();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看出MyBatis首先由<code>SqlSessionFactoryBuilder</code>读取MyBatis配置文件而构建出<code>SqlSessionFactory</code>，然后调用<code>SqlSessionFactory</code>的<code>openSession()</code>方法返回给调用方<code>SqlSession</code>，构造好了<code>SqlSession</code>，具体怎么使用呢？看下App.java下的<code>testRole()</code>：</p>
<p>大致分为获取Mapper，构建查询条件，Session提交，Session关闭（执行错误会进行Session的回滚）。</p>
<h3 id="MyBatis的配置"><a href="#MyBatis的配置" class="headerlink" title="MyBatis的配置"></a>MyBatis的配置</h3><p>MyBatis的XML配置文件大致如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</div><div class="line"><span class="meta">&lt;!DOCTYPE configuration</span></div><div class="line"><span class="meta">  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></div><div class="line"><span class="meta">  "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>  全局配置</div><div class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span><span class="tag">&lt;/<span class="name">properties</span>&gt;</span> 属性</div><div class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span><span class="tag">&lt;/<span class="name">settings</span>&gt;</span> 设置</div><div class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span> 别名</div><div class="line">    <span class="tag">&lt;<span class="name">typeHandlers</span>&gt;</span><span class="tag">&lt;/<span class="name">typeHandlers</span>&gt;</span> 类型处理器</div><div class="line">    <span class="tag">&lt;<span class="name">environments</span>&gt;</span> 环境配置</div><div class="line">        <span class="tag">&lt;<span class="name">environment</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">transactionManager</span>&gt;</span><span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span>  事物管理器</div><div class="line">            <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span><span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span> 数据源</div><div class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">databaseIdProvider</span>/&gt;</span> 数据库厂商标识</div><div class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span> 映射器</div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>其中property的配置形式可以为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/example/config.properties"</span>&gt;</span> properties文件方式</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span> 指定值方式</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;password&#125;"</span>/&gt;</span>  从properties文件读取值方式</div><div class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p><code>settings</code>则是对MyBatis的一些默认规则进行设置，比如是否延迟加载，默认执行器等等，具体配置含义查看<a href="http://www.mybatis.org/mybatis-3/zh/configuration.html" target="_blank" rel="external">MyBatis配置</a></p>
<p>别名则提供了自动包扫描和自定义的方式为开发人员提供便利：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.bazingagain.firstdemo.object"</span>&gt;</span> 包扫描方式</div><div class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">"com.bazingagain.firstdemo.object.User"</span> <span class="attr">alias</span>=<span class="string">"user"</span>/&gt;</span> 单独定义方式</div><div class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h3 id="MyBatis的映射器"><a href="#MyBatis的映射器" class="headerlink" title="MyBatis的映射器"></a>MyBatis的映射器</h3><p>对于简单的映射器，可以先看下<code>RoleMapper.xml</code>:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.bazingagain.firstdemo.mapper.RoleMapper"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        select id, role_name as roleName, note</div><div class="line">        from t_role</div><div class="line">        where id = #&#123;id&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRole"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span>&gt;</span></div><div class="line">        insert</div><div class="line">        into t_role(role_name, note)</div><div class="line">        values(#&#123;roleName&#125;, #&#123;note&#125;)</div><div class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteRole"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></div><div class="line">        delete</div><div class="line">        from t_role</div><div class="line">        where id = #&#123;id&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>其直接使用<code>select,insert,delete</code>等元素构建sql语句，但是对于比较复杂的sql结构，就需要更加灵活的方式，如<code>UserMapper.xml</code>所示：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.bazingagain.firstdemo.mapper.UserMapper"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userMap"</span> <span class="attr">type</span>=<span class="string">"user"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">javaType</span>=<span class="string">"long"</span> <span class="attr">jdbcType</span>=<span class="string">"BIGINT"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"user_name"</span> <span class="attr">property</span>=<span class="string">"userName"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"birthday"</span> <span class="attr">property</span>=<span class="string">"birthday"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">"gender"</span> <span class="attr">property</span>=<span class="string">"gender"</span> <span class="attr">typeHandler</span>=<span class="string">"org.apache.ibatis.type.EnumTypeHandler"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getUser"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span> <span class="attr">resultMap</span>=<span class="string">"userMap"</span>&gt;</span></div><div class="line">        select id, user_name, birthday, gender</div><div class="line">        from t_user</div><div class="line">        where id = #&#123;id&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertUser"</span> <span class="attr">parameterType</span>=<span class="string">"user"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></div><div class="line">        insert</div><div class="line">        into t_user(user_name, birthday, gender)</div><div class="line">        values(#&#123;userName&#125;, #&#123;birthday&#125;, #&#123;gender, typeHandler=org.apache.ibatis.type.EnumTypeHandler&#125;)</div><div class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteUser"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></div><div class="line">        delete</div><div class="line">        from t_user</div><div class="line">        where id = #&#123;id&#125;</div><div class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>其中 resultMap元素能够进行复杂的JDBC类型和Java类型的映射，进一步简化了封装过程。</p>
<h3 id="MyBatis的动态SQL"><a href="#MyBatis的动态SQL" class="headerlink" title="MyBatis的动态SQL"></a>MyBatis的动态SQL</h3><p>MyBatis提供一系列的动态SQL元素，以使我们在编写SQL语句的时候更加灵活：</p>
<ol>
<li><p>if ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultType</span>=<span class="string">"roleResultMap"</span>&gt;</span></div><div class="line">        select id, role_name as roleName, note</div><div class="line">        from t_role</div><div class="line">        where 1=1</div><div class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"roleName != null and roleName != ''"</span>&gt;</span></div><div class="line">            and role_name like concat('%', #&#123;roleName&#125;, '%')</div><div class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>choose :</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findRoles"</span> <span class="attr">parameterType</span>=<span class="string">"role"</span> <span class="attr">resultType</span>=<span class="string">"roleResultMap"</span>&gt;</span></div><div class="line">    select id, role_name as roleName, note</div><div class="line">    from t_role</div><div class="line">    where 1=1</div><div class="line">    <span class="tag">&lt;<span class="name">choose</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">"roleName != null and roleName != ''"</span>&gt;</span></div><div class="line">            and role_name like concat('%', #&#123;roleName&#125;, '%')</div><div class="line">        <span class="tag">&lt;/<span class="name">when</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">otherwise</span>&gt;</span></div><div class="line">            and note is not null</div><div class="line">        <span class="tag">&lt;/<span class="name">otherwise</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">choose</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>其它元素还包括：<br>trim, where, set,foreach, bind等，具体用法参照Mybatis3简介。</p>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过对MyBatis的简单的入门，可以看到MyBatis是一个非常灵活的持久层框架，这种灵活性在构建大型的复杂网站时是非常有必要的，</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://item.jd.com/11961241.html" target="_blank" rel="external">1.《深入浅出MyBatis技术原理与实践》</a><br><a href="http://www.mybatis.org/mybatis-3/zh/index.html" target="_blank" rel="external">2. Mybatis3简介</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/09/java-garbage-collection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Xiaolei Peng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="bazingagain">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/09/java-garbage-collection/" itemprop="url">
                  Java垃圾回收机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-09T16:26:14+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java基础/" itemprop="url" rel="index">
                    <span itemprop="name">Java基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-什么是Java中的“垃圾对象”？"><a href="#1-什么是Java中的“垃圾对象”？" class="headerlink" title="1.什么是Java中的“垃圾对象”？"></a>1.什么是Java中的“垃圾对象”？</h2><p> 垃圾回收，首先我们得明白什么是Java中的“垃圾”。那些用完的对象，不再使用的常量，不再使用的类等等，都是Java中应该回收的“垃圾”</p>
<h2 id="2-这些“垃圾对象”存放在哪里呢？"><a href="#2-这些“垃圾对象”存放在哪里呢？" class="headerlink" title="2.这些“垃圾对象”存放在哪里呢？"></a>2.这些“垃圾对象”存放在哪里呢？</h2><p>回收它，首先要知道的是这些Garbage存放在哪里呢？</p>
<p>Java虚拟机分为很多区，如方法栈、Java堆、方法区等。随着程序运行，不用的对象、常量、类等就变成了Garbage，占用着宝贵的内存。</p>
<h2 id="3-怎样判断它是不是“垃圾”？"><a href="#3-怎样判断它是不是“垃圾”？" class="headerlink" title="3.怎样判断它是不是“垃圾”？"></a>3.怎样判断它是不是“垃圾”？</h2><p>我们知道了Garbage存放在哪里，下一步便是判断哪些对象是垃圾，哪些不是，我们不能误删有用对象是吧。</p>
<p>判断是否是垃圾对象，有两种方法：</p>
<p>1.引用计数法</p>
<p>在Java中，我们都是通过引用来找到对象的，引用计数法的原理就是，<strong>对象中添加一个引用计数器</strong>，每当一个引用指向我这个对象，我这个对象的引用计数器就加1，当没有引用指向这个对象时，引用计数器的值就为0，那它就是“垃圾”对象了。是不是很简单，但它的缺点是，两个对象相互引用（循环引用），则垃圾对象就无法被回收</p>
<p>2.可达性分析</p>
<p> 可达性分析指通过一系列的<strong>“GC root”</strong>的对象来作为查找的起点，从这些点往下搜，当对象能被搜到时，从“GC root”到该对象的搜索路径便是一条<strong>“引用链”</strong>，而当一个对象无法从“GC root”向下搜到时（即没有任何引用链），说明该对象不可达，标记为“垃圾”对象。</p>
<p>GC root对象包括：</p>
<ul>
<li>虚拟机栈中的引用的对象</li>
<li>方法区中类静态变量(static)引用的对象 </li>
<li>方法区中常量(static final)引用的对象 </li>
<li>本地方法栈JNI(Native 方法)中引用的对象</li>
</ul>
<h2 id="4-该回收“垃圾了”，采用什么垃圾收集算法呢？"><a href="#4-该回收“垃圾了”，采用什么垃圾收集算法呢？" class="headerlink" title="4.该回收“垃圾了”，采用什么垃圾收集算法呢？"></a>4.该回收“垃圾了”，采用什么垃圾收集算法呢？</h2><p>Java虚拟机中常用的垃圾收集算法有以下几种：</p>
<ul>
<li><strong>标记-清除法（Mark-Sweep）</strong></li>
</ul>
<p>看名字就知道，该算法分为“标记”、“清除”两个阶段，首先标记处所有需要清除的对象，然后统一回收。这种算法会产生大量非连续的内存碎片，而当分配大对象找不到足够的连续内存时，则会触发另一次垃圾回收。</p>
<ul>
<li><strong>复制算法（Copying）</strong></li>
</ul>
<p>复制算法将内存分为许多容量大小相等的两块，每次只使用其中一块，当一块内存用完时，就讲该块中存活的对象复制到另一块中去，然后将将该块一次性清理。优点是不用考虑内存碎片问题（可移动堆顶指针按需分配），缺点是将内存缩小了一半，代价太高。</p>
<ul>
<li><strong>标记-整理法（Mark-Compact）</strong></li>
</ul>
<p>标记整理法的“标记”阶段和标记清除法一样，但是后面的阶段中，标记整理法则是将所有存活的对象移向一边，然后清理掉边界以外的内存。</p>
<ul>
<li><strong>分代收集算法（Generational Collection）</strong></li>
</ul>
<p>Java堆分为新生代和老年代，不同的代，对象的生存周期不同，因此不同的代应该采用不同的回收算法，这样能提高回收的效率，新生代中对象大量生成大量死去，只有少量存活，选用“复制”算法比较好；老年代中对象存活时间长，必须采用“标记-清除”或“标记-整理”算法。</p>
<h2 id="5-什么时候回收？"><a href="#5-什么时候回收？" class="headerlink" title="5.什么时候回收？"></a>5.什么时候回收？</h2><p>在分析回收对象的引用过程中，如果程序仍在运行，则引用关系一直在变，如果开始一个对象标记为可回收，然后执行GC，在执行GC过程中，假如又有引用指向了这个对象，则之后GC回收掉了“非垃圾”对象，这就产生了“不一致”现象，所有在GC的时候，必须停止所有的Java执行线程。</p>
<p>在选择GC的时间间隔时，既不能太长（可用内存减少），也不能太短（频繁GC，会增大运行负荷），所以，选择合适的时间点来GC，是非常重要的。而这些GC执行点便称为<strong>“安全点”（SafePoint）</strong>，只有程序运行到“安全点”时，系统才能GC。</p>
<p>“安全点”似乎解决了什么时候回收的问题，但我们仔细想一想，那些阻塞的线程呢？它们得不到CPU时间，不能进入“安全点”，怎么办？这时，就需要<strong>“安全区域”（SafeRegion）</strong>来解决，“安全区域”指一段代码中，引用关系不会发生变化，在这段区域GC都是安全的。当线程执行到<code>Safe Region</code>时，线程标识自己在SafeRegion中，此时GC，则不用管该线程是否阻塞，而当线程要离开<code>SafeRegion</code>时，则系统要检查GC是否完成，如果完成则线程继续执行，如果没有，则必须等到可离开SafeRegion信号（如完成GC Root枚举）才能离开。</p>
<h2 id="6-选用什么样的垃圾收集器？"><a href="#6-选用什么样的垃圾收集器？" class="headerlink" title="6.选用什么样的垃圾收集器？"></a>6.选用什么样的垃圾收集器？</h2><p>这么多“垃圾”，我该怎么回收啊？就像真实的垃圾场样，一台运输机搬运，搬到猴年马月啊，我们多弄几台运输机办与，垃圾一下子就搬完了。这就像Java的垃圾回收器一样，一台运输机搬运，对应的便是单线程的收集器，许多台运输机搬运，对应的便是多线程的收集器。那你就会想，肯定用多线程的呀，一下子就搬完了，还要单线程干嘛？</p>
<p>确实，单线程的收集器Serial是Java比较老的垃圾收集器了，它的单线程并不仅指用一个线程去收集，而在于它在回收垃圾时，其它工作线程必须停止。想想，如果你妈在扫垃圾，她一边扫，你一边丢，这打扫的完吗！</p>
<p>所以，经过长时间的发展，现在的收集器已经有很多了，不同的垃圾收集器适合不同的处理情况，配合使用则能提高Java内存回收的效率。</p>
<p>集中常见的垃圾收集器：</p>
<ul>
<li>Serial——单线程、新生代收集器</li>
<li>ParNew——多线程、新生代收集器</li>
<li>Parallel Scanvenge——多线程、新生代收集器、（吞吐量可控，即GC时间与用户时间的占比）、自适应调节（自动调节吞吐量）</li>
<li>Serial Old——单线程、老年代</li>
<li>Parallel Old——多线程、老年代</li>
<li>CMS——以获取最短回收停顿时间为目标，步骤：(1)初始标记（2）并发标记（3）重新标记（4）并发清除</li>
<li>G1——以获取最短回收停顿时间为目标，将Java堆划分为Region，记录Region的垃圾回收价值大小，优先回收价值较大者</li>
</ul>
<h2 id="7-Java堆中的内存分配和回收策略"><a href="#7-Java堆中的内存分配和回收策略" class="headerlink" title="7.Java堆中的内存分配和回收策略"></a>7.Java堆中的内存分配和回收策略</h2><p>我们要回收“垃圾”，肯定得先分配对象，使用完了才成为“垃圾”是吧。</p>
<ol>
<li><p><strong>一般，对象在Eden区中分配，当Eden区空间不足时，就会触发Minor GC。</strong></p>
</li>
<li><p><strong>大对象（需大量连续内存的Java对象）直接进入老年代。</strong></p>
</li>
<li><p><strong>长期存活的对象将进入老年代（对象有一个Age计数器，若对象在Eden出生，则第一次Minor GC后仍存活，并能被Survivor容纳的话，则移至Survivor区，对象Age设为1，对象在Survivor区中每过一次Minor GC，年龄加1，当Age达到一定程度[默认15–可设置]，就移至老年代），老年代的回收则是Full GC。</strong></p>
</li>
<li><p><strong>如果Survivor空间中的相同年龄的所有对象大小总和大于Survivor空间的一半，年龄大于或等于该年龄的对象则直接进入老年代。</strong></p>
</li>
</ol>
<h2 id="8-finalize-方法"><a href="#8-finalize-方法" class="headerlink" title="8.finalize()方法"></a>8.finalize()方法</h2><p>在Java中，一个对象要被真正回收，至少要经过两次标记过程：第一次可达性分析中，无引用链相连，则标记并进行筛选，筛选的条件是是否有必要执行<code>finalize()</code>方法，当对象没有覆<code>1finalize()</code>方法，或<code>finalize()</code>方法已被虚拟机执行，则都是为“没有必要执行”（即直接回收）。</p>
<p>如果该对象有必要执行<code>finalize()</code>方法，则该对象会放置在一个<strong><em>F-Queue队</em></strong>列中，之后虚拟机会自动建立一个低优先级的Finalizer线程去触发（执行）<code>finalize()</code>方法，之后，GC会对F-Queue进行第二次标记。</p>
<p>要注意的是：</p>
<p>任何一个对象的<code>finalize()</code>方法都只会被系统调用一次。如果对象在第一次<code>finalize()</code>方法中“逃脱”了，该对象在第二次GC时，它的<code>finalize()</code>方法不会执行，将被立即回收。</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="https://book.douban.com/subject/24722612/" target="_blank" rel="external">1.《深入理解Java虚拟机》</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Xiaolei Peng" />
          <p class="site-author-name" itemprop="name">Xiaolei Peng</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">Artikel</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">Kategorien</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">Tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xiaolei Peng</span>
</div>


<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
